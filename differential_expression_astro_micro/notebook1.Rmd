---
title: "first"
output: pdf_document
date: "2025-04-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## CHECK DIFFERENTIAL EXPRESSION ASTROCYTES AND MICROGLIA
 
```{r Load library}
library(SeuratObject)
library(Seurat)
library(ggplot2)
library(SingleCellExperiment)
library(tidyr)
```
 
Using obj.RData from /pipseq/data which is from line 0 to line 212 from Ellie's notebook include all the data from Single Cell folder

```{r}
#check meta data(data that describes other data) columns
colnames(obj@meta.data)
```
```{r}
#check few rows of meta data result
head(obj@meta.data)
```
```{r}
# View the cluster identity assigned to the first few cells in the Seurat object.
Idents(obj) %>% head()

# Display all the unique cluster levels currently present in the object.
levels(Idents(obj))
```
```{r}
#this renaming part copy from Ellie's code, assume all correct, find cluster of microglia and astrocytes

UMAP_cluster_ids <- c(
  "0" = "Oligodendrocytes",
  "1" = "L2/3IT",
  "2" = "L5IT",
  "3" = "L6IT",
  "4" = "L5ET",
  "5" = "Microglia",
  "6" = "Astrocytes", 
  "7" = "L6CT",
  "8" = "VIP/Lamp5IN",
  "9" = "L2/3IT",
  "10" = "SST/PVIN",
  "11" = "Oligodendrocytes",
  "12" = "OPC",
  "13" = "L5/6NP",
  "14" = "Microglia",
  "15" = "Astrocytes", 
  "16" = "VLMC",
  "17" = "Endo",
  "18" = "VLMC",
  "19" = "Pericytes", 
  "20" = "L2/3IT",
  "21" = "Microglia"
)
Idents(obj) <- obj$seurat_clusters
names(UMAP_cluster_ids) <- levels(obj)
obj <- RenameIdents(obj, UMAP_cluster_ids)
```

```{r}
DimPlot(
  obj,
  reduction = "umap.unintegrated",
  group.by = "condition",
  label = FALSE, # Adds the subclass name to the plot
  label.size = 4 # Adjusts the font size of the labels
)
```

```{r}
#check if renaming works
Idents(obj) %>% head()
levels(Idents(obj))
```
```{r}
table(Idents(obj))
```

```{r}
#group clusters 
microglia  <- subset(obj, idents = "Microglia")
astrocytes <- subset(obj, idents = "Astrocytes")
```

```{r}
# Subset microglia and astrocytes to only include those with fewer than 3000 detected genes
microglia <- subset(microglia, nFeature_RNA < 3000)
table(microglia$orig.ident)
astrocytes <- subset(astrocytes, nFeature_RNA < 3000)
table(astrocytes$orig.ident)
```
```{r}
Assays(microglia)
Assays(astrocytes)
```
```{r}
#create seurat object by using slot = data
#fixing because updated to Seurat V5, and it should be using layer
microglia <- CreateSeuratObject(counts = GetAssayData(microglia, layer = "counts"))
astrocytes <- CreateSeuratObject(counts = GetAssayData(astrocytes, layer = "counts"))

```

```{r}
#Normalize microglia
microglia <- NormalizeData(microglia)
microglia <- FindVariableFeatures(microglia)
microglia <- ScaleData(microglia)
microglia <- RunPCA(microglia)
microglia <- FindNeighbors(microglia, dims = 1:15)
microglia <- FindClusters(microglia, resolution = 0.3)
microglia <- RunUMAP(microglia, dims = 1:15)
```

```{r}
#Normalize astrocytes
astrocytes <- NormalizeData(astrocytes)
astrocytes <- FindVariableFeatures(astrocytes)
astrocytes <- ScaleData(astrocytes)
astrocytes <- RunPCA(astrocytes)
astrocytes <- FindNeighbors(astrocytes, dims = 1:15)
astrocytes <- FindClusters(astrocytes, resolution = 0.3)
astrocytes <- RunUMAP(astrocytes, dims = 1:15)
```

```{r}
#cell type label for each subset
astrocytes$celltype <- "Astrocytes"
microglia$celltype <- "Microglia"
```

```{r}
#merges the astrocytes and microglia Seurat objects into a single object
combined_obj <- JoinLayers(combined_obj)
```

```{r}
Assays(combined_obj)
```
```{r}
Layers(combined_obj)
```


```{r}
#compares astrocytes vs. microglia to identify differentially expressed genes
astro_micro_de <- FindMarkers(
  combined_obj,
  ident.1 = "Astrocytes",
  ident.2 = "Microglia",
  logfc.threshold = 0.25,    
  min.pct = 0.1,              
  test.use = "wilcox"        
)
```

```{r}
astro_micro_de_sorted <- astro_micro_de[order(astro_micro_de$p_val_adj), ]
head(astro_micro_de_sorted, 20) 
```
```{r}
write.csv(astro_micro_de, "one.csv", row.names = TRUE)
write.csv(astro_micro_de, "two.csv", row.names = TRUE)

```

```{r}
# Read the full differential expression result
one <- read.csv("astro_vs_microglia_DE.csv", row.names = 1)

# Read the top 20 sorted genes
two <- read.csv("astro_micro_de_sorted.csv", row.names = 1)
```

```{r}
# Read the full differential expression result
three <- read.csv("one.csv", row.names = 1)

# Read the top 20 sorted genes
four <- read.csv("two.csv", row.names = 1)
```

```{r}
df1 <- two
df2 <- four

#row names 
genes1 <- rownames(df1)
genes2 <- rownames(df2)

# Find overlapping genes
common_genes <- intersect(genes1, genes2)

length(common_genes)      # how many overlap
head(common_genes, 10)    # preview of overlaps

```

```{r}
deg <- three
deg$gene <- rownames(deg)
deg$log10p <- -log10(deg$p_val_adj)

# Cap extreme y-axis values
deg$log10p_capped <- pmin(deg$log10p, 50)

# Add significance group
deg$significance <- ifelse(
  deg$p_val_adj < 0.05 & abs(deg$avg_log2FC) > 0.25,
  "Significant",
  "Not significant"
)

# Label only the most significant genes: top 20 by score
score <- deg$log10p * abs(deg$avg_log2FC)
top_genes <- order(score, decreasing = TRUE)[1:20]
deg$label <- NA
deg$label[top_genes] <- deg$gene[top_genes]



```


```{r}
library(ggplot2)
library(ggrepel)

ggplot(deg, aes(x = avg_log2FC, y = log10p_capped)) +
  geom_point(aes(color = significance), alpha = 0.4) +
  geom_text_repel(aes(label = label), size = 3, max.overlaps = 30) +
  scale_color_manual(values = c("Significant" = "red", "Not significant" = "grey")) +
  geom_vline(xintercept = c(-0.25, 0.25), linetype = "dotted", color = "black") +
  geom_hline(yintercept = -log10(0.05), linetype = "dotted", color = "black") +
  labs(
    title = "Astrocytes vs. Microglia DEGs",
    x = "Log2 Fold Change",
    y = "-log10 Adjusted P-value",
    color = "Significance"
  ) +
  theme_minimal()


```

```{r}
top_genes <- rownames(deg[order(deg$p_val_adj), ])[1:30]

expr_matrix <- GetAssayData(combined_obj, layer = "data")

# Subset to top DE genes
heatmap_data <- expr_matrix[top_genes, ]
```

```{r}

# Ensure valid data
heatmap_data <- as.matrix(heatmap_data)
heatmap_data <- heatmap_data[complete.cases(heatmap_data), ]
annotation_col = data.frame(CellType = combined_obj$celltype)

# Plot
library(pheatmap)
pheatmap(heatmap_data,
         cluster_rows = TRUE,
         cluster_cols = FALSE,
         scale = "row",        # normalize across rows
         show_rownames = TRUE,
         show_colnames = FALSE,
         fontsize_row = 8,
         annotation_col = annotation_col)

```

